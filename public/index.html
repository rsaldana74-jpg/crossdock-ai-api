<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crossdock AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="app">

    <!-- LEFT SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logoRing">
          <img class="brandLogo" src="/logo.png" alt="Crossdock" onerror="this.style.display='none'" />
          <div class="brandFallback">CROSSDOCK</div>
        </div>

        <div class="brandTitle">
          <div class="brandAI">AI</div>
          <div class="brandSub">Your 3PL Global Partner</div>
        </div>
      </div>

      <div class="sidebarHeader">
        <div class="sidebarTitle">Chats</div>
        <button class="newChat" onclick="newChat()">Ôºã New</button>
      </div>

      <div id="chatList" class="chatList"></div>

      <div class="sidebarFooter">
        <div class="hint">Tip: click a chat to load it</div>
      </div>
    </aside>

    <!-- MAIN CHAT AREA -->
    <main class="main">
      <header class="topbar">
        <div class="topbarLeft">
          <div class="dot"></div>
          <div class="topbarTitle">Crossdock AI Assistant</div>
        </div>

        <div class="topbarRight">
          <a class="pill" href="/api/ask" target="_blank" rel="noreferrer">API</a>
          <button class="pill" onclick="clearChat()">Clear</button>

          <!-- SETTINGS -->
          <div class="settings">
            <button class="pill" onclick="toggleSettings()">‚öôÔ∏è Settings</button>

            <div id="settingsPanel" class="settingsPanel hidden">
              <label>
                Language
                <select id="languageSelect" onchange="setLanguage(this.value)">
                  <option value="en">English</option>
                  <option value="es">Espa√±ol</option>
                  <option value="fr">Fran√ßais</option>
                  <option value="de">Deutsch</option>
                  <option value="it">Italiano</option>
                  <option value="pt">Portugu√™s</option>
                  <option value="zh">‰∏≠Êñá</option>
                  <option value="ja">Êó•Êú¨Ë™û</option>
                  <option value="ko">ÌïúÍµ≠Ïñ¥</option>
                  <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                  <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                  <option value="nl">Nederlands</option>
                  <option value="sv">Svenska</option>
                  <option value="pl">Polski</option>
                  <option value="tr">T√ºrk√ße</option>
                </select>
              </label>

              <label>
                Theme
                <select id="themeSelect" onchange="setTheme(this.value)">
                  <option value="dark">Dark</option>
                  <option value="light">Light</option>
                </select>
              </label>
            </div>
          </div>

        </div>
      </header>

      <section class="chatWrap">
        <div class="chatPanel">
          <div class="chatPanelHeader">
            <div class="aiBadge">AI</div>
            <div class="chatPanelTitle">
              <div class="hello">Hello!</div>
              <div class="prompt">Which logistics questions can I answer for you?</div>
            </div>
          </div>

          <div class="chips">
            <button class="chip" onclick="useChip('Explain intermodal vs truckload for steel shipments')">Intermodal vs Truck</button>
            <button class="chip" onclick="useChip('Write an email to quote Chicago ‚Üí Silao intermodal')">Quote Email</button>
            <button class="chip" onclick="useChip('How do I reduce damage risk for coils in a 53\\' container?')">Coil Safety</button>
            <button class="chip" onclick="useChip('Give me a 7-day lane pitch for Midwest ‚Üí Central Mexico')">7-Day Pitch</button>
          </div>

          <div id="messages" class="messages"></div>

          <div class="composer">
            <textarea id="question" rows="1" placeholder="Type something‚Ä¶"></textarea>

            <button class="sendBtn" onclick="askAI()" aria-label="Send">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M3 11.5L21 3l-8.5 18-2.7-7.2L3 11.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                <path d="M21 3 9.8 13.8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>

          <div id="status" class="status hidden">Thinking‚Ä¶</div>
        </div>

        <div class="cornerArrow" aria-hidden="true"></div>
      </section>
    </main>

  </div>

  <script>
    // -------------------------
    // Settings persistence
    // -------------------------
    let currentLanguage = localStorage.getItem("crossdock_lang") || "en";
    let currentTheme = localStorage.getItem("crossdock_theme") || "dark";

    function setLanguage(lang) {
      currentLanguage = lang;
      localStorage.setItem("crossdock_lang", lang);
    }

    function setTheme(theme) {
      currentTheme = theme;
      document.body.dataset.theme = theme;
      localStorage.setItem("crossdock_theme", theme);
    }

    function toggleSettings() {
      document.getElementById("settingsPanel").classList.toggle("hidden");
    }

    // Close settings when clicking outside
    document.addEventListener("click", (e) => {
      const panel = document.getElementById("settingsPanel");
      const wrapper = document.querySelector(".settings");
      if (!wrapper.contains(e.target)) panel.classList.add("hidden");
    });

    // init theme + selects
    document.body.dataset.theme = currentTheme;
    window.addEventListener("DOMContentLoaded", () => {
      const langSelect = document.getElementById("languageSelect");
      const themeSelect = document.getElementById("themeSelect");
      langSelect.value = currentLanguage;
      themeSelect.value = currentTheme;
    });

    // -------------------------
    // Simple chat storage (local)
    // -------------------------
    const STORAGE_KEY = "crossdock_ai_chats_v2";
    let chats = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    let activeChatId = chats[0]?.id || null;

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(chats));
    }

    function uid() {
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function ensureFirstChat() {
      if (!chats.length) {
        const id = uid();
        chats = [{ id, title: "New chat", messages: [] }];
        activeChatId = id;
        save();
      }
    }

    function getActiveChat() {
      return chats.find(c => c.id === activeChatId);
    }

    function setActive(id) {
      activeChatId = id;
      renderChatList();
      renderMessages();
    }

    function newChat() {
      const id = uid();
      chats.unshift({ id, title: "New chat", messages: [] });
      activeChatId = id;
      save();
      renderChatList();
      renderMessages();
      document.getElementById("question").focus();
    }

    function clearChat() {
      const c = getActiveChat();
      if (!c) return;
      c.messages = [];
      c.title = "New chat";
      save();
      renderChatList();
      renderMessages();
    }

    function deleteChat(id) {
      chats = chats.filter(c => c.id !== id);
      if (activeChatId === id) {
        activeChatId = chats[0]?.id || null;
      }
      if (!chats.length) {
        ensureFirstChat();
      }
      save();
      renderChatList();
      renderMessages();
    }

    function renderChatList() {
      const list = document.getElementById("chatList");
      list.innerHTML = "";

      chats.forEach(c => {
        const row = document.createElement("div");
        row.className = "chatItem" + (c.id === activeChatId ? " active" : "");
        row.onclick = () => setActive(c.id);

        const left = document.createElement("div");
        left.className = "chatItemLeft";

        const title = document.createElement("div");
        title.className = "chatItemTitle";
        title.textContent = c.title || "Chat";

        const meta = document.createElement("div");
        meta.className = "chatItemMeta";
        meta.textContent = (c.messages?.length || 0) + " msgs";

        left.appendChild(title);
        left.appendChild(meta);

        const trash = document.createElement("button");
        trash.className = "trashBtn";
        trash.title = "Delete chat";
        trash.innerHTML = "üóëÔ∏è";
        trash.onclick = (e) => {
          e.stopPropagation();
          deleteChat(c.id);
        };

        row.appendChild(left);
        row.appendChild(trash);
        list.appendChild(row);
      });
    }

    function renderMessages() {
      const c = getActiveChat();
      const box = document.getElementById("messages");
      box.innerHTML = "";

      if (!c || !c.messages.length) {
        const empty = document.createElement("div");
        empty.className = "emptyState";
        empty.innerHTML = `
          <div class="emptyTitle">Start a conversation</div>
          <div class="emptyText">Ask about rates, routing, transit, intermodal lanes, claims, documentation, or sales messaging.</div>
        `;
        box.appendChild(empty);
        return;
      }

      c.messages.forEach(m => {
        const row = document.createElement("div");
        row.className = "msgRow " + (m.role === "user" ? "user" : "ai");

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = m.text;

        row.appendChild(bubble);
        box.appendChild(row);
      });

      box.scrollTop = box.scrollHeight;
    }

    function useChip(text) {
      document.getElementById("question").value = text;
      document.getElementById("question").focus();
    }

    // Enter to send, Shift+Enter newline
    const q = document.getElementById("question");
    q.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        askAI();
      }
    });

    function autoTitleFromQuestion(question) {
      // Good ‚Äútopic-style‚Äù title
      const cleaned = question
        .replace(/\s+/g, " ")
        .trim()
        .replace(/[^\p{L}\p{N}\s\-‚Üí]/gu, "");

      const words = cleaned.split(" ").slice(0, 6).join(" ");
      return words.length ? (words.length > 34 ? words.slice(0, 34) + "‚Ä¶" : words) : "New chat";
    }

    async function askAI() {
      const input = document.getElementById("question");
      const status = document.getElementById("status");
      const question = input.value.trim();
      if (!question) return;

      const c = getActiveChat();
      if (!c) return;

      // add user message
      c.messages.push({ role: "user", text: question });

      // auto-name chat topic on first message
      if (!c.title || c.title === "New chat") {
        c.title = autoTitleFromQuestion(question);
      }

      input.value = "";
      save();
      renderChatList();
      renderMessages();

      status.classList.remove("hidden");

      try {
        const res = await fetch("/api/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question, language: currentLanguage })
        });

        const data = await res.json();

        if (!res.ok) {
          const msg = data?.error || data?.message || "Request failed";
          throw new Error(msg);
        }

        c.messages.push({ role: "ai", text: data.answer || "(No answer returned)" });
        save();
        renderMessages();
      } catch (err) {
        c.messages.push({ role: "ai", text: "Error: " + err.message });
        save();
        renderMessages();
      } finally {
        status.classList.add("hidden");
      }
    }

    // init
    ensureFirstChat();
    if (!activeChatId) activeChatId = chats[0].id;
    renderChatList();
    renderMessages();
  </script>
</body>
</html>